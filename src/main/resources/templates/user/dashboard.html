<!DOCTYPE html>
<html th:replace="~{user/user_base :: parent('Dashboard',~{:: #div1},~{:: #jsScript})}">

<div id="div1" class="p-4 sm:ml-64">
    <div class="p-6 border border-gray-200 rounded-2xl dark:border-gray-700 mt-14 bg-gray-50 dark:bg-gray-900">

        <!-- User Profile Card -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-sm flex items-center space-x-4">
                <img th:src="${profilePic}" alt="Profile Picture" class="w-16 h-16 rounded-full object-cover border"
                    onerror="this.onerror=null;this.src='/images/default-avatar.png';">

                <div>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200" th:text="${user.name}">User Name
                    </h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400" th:text="${user.email}"></p>
                    <span
                        class="px-2 py-1 mt-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Active</span>
                </div>
            </div>
        </div>

        <!-- PDF Thumbnail Gallery -->
        <div class="my-4">
            <h2 class="text-xl font-semibold mb-6 text-gray-800 dark:text-gray-200">Your Documents</h2>

            <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
                <div th:each="doc : ${documentList}" class="flex flex-col items-center text-center group">

                    <!-- Thumbnail -->
                    <div class="relative w-28 h-40 sm:w-32 sm:h-48 md:w-40 md:h-56 
                                bg-gray-100 dark:bg-gray-800 rounded-lg overflow-hidden 
                                flex items-center justify-center cursor-pointer"
                        th:onclick="'openPdf('+${doc.id}+');'">

                        <!-- Loader Spinner -->
                        <div class="absolute inset-0 flex items-center justify-center bg-gray-200 dark:bg-gray-700"
                            th:id="'loader-' + ${doc.id}">
                            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-gray-600"></div>
                        </div>


                        <!-- Image -->
                        <!-- <img th:id th:src="@{/document/thumbnails/{id}(id=${doc.id})}" alt="PDF Thumbnail"
                            class="w-full h-full object-cover rounded-lg shadow-sm transition group-hover:shadow-md"
                            onerror="this.onerror=null; this.src='/images/placeholder.png' /> -->
                        <img th:id="'thumb-' + ${doc.id}" th:src="@{/document/thumbnails/{id}(id=${doc.id})}"
                            alt="PDF Thumbnail"
                            class="w-full h-full object-cover rounded-lg shadow-sm transition group-hover:shadow-md" />


                        <!-- Overlay hover -->
                        <div class="absolute inset-0 bg-black bg-opacity-30 opacity-0 
                                    group-hover:opacity-100 flex items-center justify-center 
                                    text-white text-xs font-medium transition">
                            Open PDF
                        </div>
                    </div>

                    <!-- File name -->
                    <p class="mt-3 text-sm font-medium text-gray-800 dark:text-gray-300 w-32 truncate"
                        th:title="${doc.fileName}" th:text="${doc.fileName}"></p>
                </div>
            </div>


            <!-- <div id="pdfViewerContainer" class="mt-8 hidden">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">PDF Preview</h3>
                <iframe id="pdfViewer" width="100%" height="600px" style="border:none;"></iframe>
            </div> -->
        </div>
    </div>
    <!-- Model to show Pdf -->
    <div id="pdfModal" class="fixed inset-0 bg-black bg-opacity-90 flex flex-col z-50 hidden">

        <!-- Modal Header -->
        <div class="flex justify-between items-center p-4 bg-gray-900 text-white">
            <h3 class="text-lg font-semibold">PDF Viewer</h3>
            <button onclick="closePdfModal()" class="text-white hover:text-gray-300 text-2xl leading-none">
                ✕
            </button>
        </div>

        <!-- Loader -->
        <div id="pdfLoader" class="flex-1 flex items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white"></div>
        </div>

        <!-- Modal Body -->
        <div class="flex-1 hidden" id="pdfContent">
            <iframe id="pdfViewer" class="w-full h-full" style="border:none;"></iframe>
        </div>
    </div>
    <!-- <div id="pdfModal" class="fixed inset-0 bg-black bg-opacity-90 flex flex-col z-50 hidden">
        <div class="flex justify-between items-center p-4 bg-gray-900 text-white">
            <h3 class="text-lg font-semibold">PDF Viewer</h3>
            <button onclick="closePdfModal()" class="text-white hover:text-gray-300 text-2xl leading-none">✕</button>
        </div>

        <div id="pdfContainer" class="flex-1 overflow-auto bg-gray-100 relative"></div>
    </div> -->





</div>

<script id="jsScript">
    function hideLoader(docId) {
        const loader = document.getElementById("loader-" + docId);
        if (loader) {
            loader.style.display = "none"; // hide the loader
        }
    }
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("img[id^='thumb-']").forEach(img => {
            const docId = img.id.replace("thumb-", "");
            img.onload = () => hideLoader(docId);
            img.onerror = () => {
                img.src = "/images/placeholder.png";
                hideLoader(docId);
            };
        });
    });
    function openPdf(docId) {
        const modal = document.getElementById("pdfModal");
        const iframe = document.getElementById("pdfViewer");
        const loader = document.getElementById("pdfLoader");
        const content = document.getElementById("pdfContent");

        // Show loader, hide content
        loader.classList.remove("hidden");
        content.classList.add("hidden");

        iframe.src = "/document/" + docId + "/view";
        modal.classList.remove("hidden");

        // When PDF finishes loading
        iframe.onload = function () {
            loader.classList.add("hidden");
            content.classList.remove("hidden");
        };
    };


    // let currentDocId = null; // declare globally at top of script

    // async function openPdf(docId) {
    //     currentDocId = docId; // ✅ set the global here
    //     const modal = document.getElementById("pdfModal");
    //     const container = document.getElementById("pdfContainer");
    //     container.innerHTML = "";
    //     modal.classList.remove("hidden");

    //     pdfjsLib.GlobalWorkerOptions.workerSrc =
    //         "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

    //     const pdf = await pdfjsLib.getDocument(`/document/${docId}/view`).promise;

    //     for (let i = 1; i <= pdf.numPages; i++) {
    //         const page = await pdf.getPage(i);
    //         const viewport = page.getViewport({ scale: 1.5 });

    //         const canvas = document.createElement("canvas");
    //         canvas.width = viewport.width;
    //         canvas.height = viewport.height;
    //         canvas.className = "block mx-auto mb-4 relative";
    //         const context = canvas.getContext("2d");
    //         await page.render({ canvasContext: context, viewport }).promise;

    //         const textLayerDiv = document.createElement("div");
    //         textLayerDiv.className = "textLayer absolute top-0 left-0";
    //         textLayerDiv.style.width = `${viewport.width}px`;
    //         textLayerDiv.style.height = `${viewport.height}px`;
    //         textLayerDiv.style.pointerEvents = "none";

    //         const textContent = await page.getTextContent();
    //         pdfjsLib.renderTextLayer({
    //             textContent,
    //             container: textLayerDiv,
    //             viewport,
    //             textDivs: []
    //         });

    //         const wrapper = document.createElement("div");
    //         wrapper.className = "relative";
    //         wrapper.style.width = `${viewport.width}px`;
    //         wrapper.style.height = `${viewport.height}px`;
    //         wrapper.dataset.page = i; // ✅ store page number for later use
    //         wrapper.appendChild(canvas);
    //         wrapper.appendChild(textLayerDiv);

    //         wrapper.addEventListener("mouseup", () => handleTextSelection(i, wrapper));

    //         container.appendChild(wrapper);
    //     }

    //     // ✅ After rendering, load existing annotations for this doc
    //     loadAnnotations(docId);
    // }


    // function handleTextSelection(pageNumber, wrapper) {
    //     const selection = window.getSelection();
    //     if (!selection || selection.isCollapsed) return;

    //     const range = selection.getRangeAt(0);
    //     const rect = range.getBoundingClientRect();
    //     const wrapperRect = wrapper.getBoundingClientRect();

    //     // Position highlight relative to PDF page
    //     const highlight = document.createElement("div");
    //     highlight.className = "absolute bg-yellow-300 opacity-50 rounded";
    //     highlight.style.top = `${rect.top - wrapperRect.top}px`;
    //     highlight.style.left = `${rect.left - wrapperRect.left}px`;
    //     highlight.style.width = `${rect.width}px`;
    //     highlight.style.height = `${rect.height}px`;
    //     highlight.dataset.page = pageNumber;

    //     // Add click → show note popup
    //     highlight.addEventListener("click", (e) => {
    //         e.stopPropagation();
    //         const note = prompt("Add a note for this highlight:");
    //         if (note) {
    //             highlight.title = note; // tooltip
    //             saveAnnotation({
    //                 docId: currentDocId,
    //                 page: pageNumber,
    //                 coords: {
    //                     top: rect.top - wrapperRect.top,
    //                     left: rect.left - wrapperRect.left,
    //                     width: rect.width,
    //                     height: rect.height,
    //                 },
    //                 text: selection.toString(),
    //                 note
    //             });
    //         }
    //     });

    //     wrapper.appendChild(highlight);
    //     selection.removeAllRanges();
    // }


    // async function loadAnnotations(docId) {
    //     const response = await fetch(`/annotations/${docId}`);
    //     if (!response.ok) return;

    //     const annotations = await response.json(); // assume list of { page, coords, note, text }
    //     annotations.forEach(ann => {
    //         const wrapper = document.querySelector(`[data-page="${ann.page}"]`);
    //         if (!wrapper) return;

    //         const highlight = document.createElement("div");
    //         highlight.className = "absolute bg-yellow-300 opacity-50 rounded";
    //         highlight.style.top = `${ann.coords.top}px`;
    //         highlight.style.left = `${ann.coords.left}px`;
    //         highlight.style.width = `${ann.coords.width}px`;
    //         highlight.style.height = `${ann.coords.height}px`;
    //         highlight.title = ann.note;
    //         highlight.dataset.page = ann.page;

    //         wrapper.appendChild(highlight);
    //     });
    // }


    // async function saveAnnotation(annotation) {
    //     // Call Spring Boot REST API
    //     await fetch("/annotations", {
    //         method: "POST",
    //         headers: { "Content-Type": "application/json" },
    //         body: JSON.stringify(annotation)
    //     });
    // }

    // function closePdfModal() {
    //     const modal = document.getElementById("pdfModal");
    //     const container = document.getElementById("pdfContainer");
    //     modal.classList.add("hidden");
    //     container.innerHTML = ""; // ✅ clear pages
    //     currentDocId = null;
    // }






    function closePdfModal() {
        const modal = document.getElementById("pdfModal");
        const iframe = document.getElementById("pdfViewer");

        modal.classList.add("hidden");
        iframe.src = ""; // reset pdf
    };

</script>

</html>